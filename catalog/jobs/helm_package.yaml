parameters:
  chart_directory:
    type: "string"
    description: "Helm chart directory."
    default: "helm/${CIRCLE_PROJECT_REPONAME}-chart"
machine: true
steps:
  - run:
      name: "Creates a helm chart archive"
      command: |
        set -o errexit
        set -o nounset
        set -o pipefail
         echo_green() {
          echo -e "\e[32m${1}\e[0m"
        }
        echo_red() {
          echo -e "\e[31m${1}\e[0m"
        }
        echo_yellow() {
          echo -e "\e[33m${1}\e[0m"
        }

        readonly helm_dir=<<parameters.chart_directory>>
        readonly helm_url=https://storage.googleapis.com/kubernetes-helm
        readonly helm_tarball=helm-v2.11.0-linux-amd64.tar.g
        readonly last_tag=$(git describe --tags $(git rev-list --tags --max-count=1))
        setup_helm_client() {
          echo "installing helm binary"
          curl --user-agent curl-ci-sync -sSL -o "${helm_tarball}" "${helm_url}/${helm_tarball}"
          tar xzfv "${helm_tarball}"
          PATH="$(pwd)/linux-amd64/:$PATH"
         echo "installed helm binary"
        }

        setup_helm_client
        if [ $last_tag ];then
            version=${last_tag//v}"-"${CIRCLE_SHA1}
        else
            version="0.0.0-"${CIRCLE_SHA1}
        fi

        echo ${version}
        sed -i -e "s/\[\[ \.VERSION \]\]/${verion}/g" $(find $helm_dir -type f)
        echo $(grep -nr $CIRCLE_SHA1 $helm_dir)
        helm package ${helm_dir} -d ${CIRCLE_WORKING_DIRECTORY}

        echo_green "ok: created chart tarball"
